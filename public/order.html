<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sipariş Adımları</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    .container{max-width:980px;margin:0 auto;padding:24px}
    .row{display:flex;gap:24px;flex-wrap:wrap}
    .card{flex:1;min-width:280px;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;background:rgba(255,255,255,.04)}
    .title{font-size:12px;color:#c6c6cc;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
    .big{font-size:96px;font-weight:800;line-height:1}
    .controls{display:flex;align-items:center;gap:8px;margin-top:12px;flex-wrap:wrap}
    .btn{padding:10px 12px;border:1px solid rgba(255,255,255,.18);border-radius:10px;background:rgba(255,255,255,.04);color:#fff;cursor:pointer}
    .list{display:flex;flex-direction:column;gap:8px}
    .item{display:flex;gap:10px;align-items:center;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.02)}
    .item.current{border-color:rgba(255,255,255,.35);background:rgba(255,255,255,.08);font-weight:800}
    .spin{width:110px;text-align:right;padding:10px;border:1px solid rgba(255,255,255,.18);border-radius:10px;background:rgba(255,255,255,.04);color:#fff}
    .small{font-size:12px;color:#c6c6cc}
  </style>

  <style>
    @media (max-width: 520px){
      .big{font-size:72px}
      .controls{gap:6px}
      .spin{width:100px}
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="small">← Yeni sorgu</a>
    <h1>Sipariş <span id="orderNo"></span></h1>
    <div class="row">
      <div class="card" style="flex:2">
        <div class="title">Mevcut adım</div>
        <div class="big" id="currentStep">-</div>
        <div class="small" id="progress">0 / 0</div>
        <div class="controls">
          <button id="prev" class="btn" title="Önceki (←)">←</button>
          <button id="play" class="btn" aria-pressed="false" title="Oynat/Duraklat (Space)">▶</button>
          <input id="intervalSec" class="spin" type="number" min="1" step="1" value="5" title="Süre (saniye)" />
          <button id="next" class="btn" title="Sonraki (→)">→</button>
          <input id="jumpInput" class="spin" type="text" placeholder="Adıma git" />
          <button id="jumpBtn" class="btn">Git</button>
        </div>
      </div>
      <div class="card" style="flex:1">
        <div class="title">Adım listesi</div>
        <div id="list" class="list"></div>
      </div>
    </div>
  </div>

  <script>
    function getOrderFromPath(){ const parts = window.location.pathname.split('/'); return decodeURIComponent(parts[2] || ''); }
    const orderNo = getOrderFromPath(); document.getElementById('orderNo').textContent = orderNo;

    const state = { steps: [], index: 0, timer: null };

    async function load(){
      const res = await fetch('/api/order/' + encodeURIComponent(orderNo));
      if(!res.ok){ alert('Kayıt bulunamadı.'); location.href='/'; return; }
      const arr = await res.json();
      state.steps = Array.isArray(arr) ? arr : (arr.steps || []);
      state.index = 0; render();
    }

    function render(){
      const cur = state.steps[state.index];
      document.getElementById('currentStep').textContent = cur ? cur.notch : '-';
      document.getElementById('progress').textContent = `${state.index+1} / ${state.steps.length}`;

      const list = document.getElementById('list'); list.innerHTML = '';
      const start = Math.max(0, state.index - 3);
      const end = Math.min(state.steps.length - 1, state.index + 3);
      for(let i=start; i<=end; i++){
        const item = state.steps[i];
        const row = document.createElement('div');
        row.className = 'item' + (i===state.index ? ' current' : '');
        row.textContent = `${item.notch}`; // sadece çentik değeri
        list.appendChild(row);
      }
    }

    function next(){ if(state.index < state.steps.length - 1){ state.index++; render(); } else { stop(); } }
    function prev(){ if(state.index > 0){ state.index--; render(); } }
    function getIntervalMs(){ const sec = parseInt(document.getElementById('intervalSec').value,10); return (Number.isFinite(sec)&&sec>=1?sec:5)*1000; }
    function play(){ if(state.timer) return; state.timer=setInterval(next, getIntervalMs()); document.getElementById('play').setAttribute('aria-pressed','true'); document.getElementById('play').textContent='⏸'; }
    function stop(){ if(state.timer){ clearInterval(state.timer); state.timer=null; document.getElementById('play').setAttribute('aria-pressed','false'); document.getElementById('play').textContent='▶'; } }

    document.getElementById('prev').onclick = prev;
    document.getElementById('next').onclick = next;
    document.getElementById('play').onclick = () => state.timer ? stop() : play();
    document.getElementById('intervalSec').addEventListener('change', () => { if(state.timer){ stop(); play(); } });
    document.getElementById('jumpBtn').onclick = () => {
      const v = parseInt(document.getElementById('jumpInput').value,10);
      if(Number.isFinite(v)){ const idx=v-1; if(idx>=0 && idx < state.steps.length){ state.index = idx; render(); } }
    };
    window.addEventListener('keydown', (e) => {
      if(e.key === 'ArrowRight') next();
      if(e.key === 'ArrowLeft') prev();
      if(e.code === 'Space'){ e.preventDefault(); state.timer ? stop() : play(); }
    });

    load();
  </script>
</body>
</html>
