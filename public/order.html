<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sipariş Adımları</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    /* highlight for current item in the list */
    .step-list-item{display:flex;gap:10px;align-items:center;padding:8px 10px;border-radius:10px;border:1px solid #eee}
    .step-list-item.current{border-color:#111;background:#f2f2f2;font-weight:700}
    .step-dot{width:12px;height:12px;border-radius:50%;border:2px solid #111}
    .step-dot.current{background:#111}
    .spinner{display:inline-flex;align-items:center;gap:6px}
    .spin-input{width:90px;text-align:right;padding:8px 10px;border:1px solid #ccc;border-radius:8px}
    .spin-btn{padding:8px 10px;border:1px solid #ccc;border-radius:8px;background:#fff;cursor:pointer}
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="small">← Yeni sorgu</a>
    <h1>Sipariş <span id="orderNo"></span></h1>
    <div class="row">
      <div class="card" style="flex:2">
        <div class="title">Mevcut adım</div>
        <div class="big" id="currentStep">-</div>
        <div class="progress small" id="progress">0 / 0</div>
        <div class="controls">
          <button id="prev" class="control-btn" title="Önceki (←)">←</button>
          <button id="play" class="control-btn" aria-pressed="false" title="Oynat/Duraklat (Space)">▶</button>
          <div class="spinner" title="Süre (ms)">
            <button id="dec" class="spin-btn" aria-label="Süreyi azalt">▼</button>
            <input id="intervalMs" class="spin-input" type="number" min="500" step="500" value="5000" />
            <button id="inc" class="spin-btn" aria-label="Süreyi artır">▲</button>
          </div>
          <button id="next" class="control-btn" title="Sonraki (→)">→</button>
          <input id="jumpInput" type="text" placeholder="Adıma git (örn: 42)" style="max-width:160px" />
          <button id="jumpBtn" class="control-btn">Git</button>
        </div>
      </div>
      <div class="card" style="flex:1">
        <div class="title">Adım listesi</div>
        <div id="list" class="list"></div>
      </div>
    </div>
    
  </div>

  <script>
    function getOrderFromPath(){
      const parts = window.location.pathname.split("/");
      return decodeURIComponent(parts[2] || "");
    }

    const orderNo = getOrderFromPath();
    document.getElementById("orderNo").textContent = orderNo;

    const state = { steps: [], index: 0, timer: null };

    async function load(){
      const res = await fetch(`/api/order/${encodeURIComponent(orderNo)}`);
      if(!res.ok){
        alert("Kayıt bulunamadı.");
        location.href = "/";
        return;
      }
      const data = await res.json();
      state.steps = data.steps || [];
      state.index = 0;
      render();
    }

    function render(){
      const cur = state.steps[state.index];
      document.getElementById("currentStep").textContent = cur ? cur.notch : "-";
      document.getElementById("progress").textContent = `${state.index+1} / ${state.steps.length}`;

      // Render 7 items: 3 before, current, 3 after
      const list = document.getElementById("list");
      list.innerHTML = "";
      const start = Math.max(0, state.index - 3);
      const end = Math.min(state.steps.length - 1, state.index + 3);
      for(let i=start;i<=end;i++){
        const item = state.steps[i];
        const row = document.createElement("div");
        row.className = "step-list-item" + (i===state.index ? " current" : "");
        const dot = document.createElement("div");
        dot.className = "step-dot" + (i===state.index ? " current" : "");
        row.appendChild(dot);
        const txt = document.createElement("div");
        // Show ONLY the notch (no step index)
        txt.textContent = `${item.notch}`;
        row.appendChild(txt);
        list.appendChild(row);
      }
    }

    function next(){
      if(state.index < state.steps.length - 1){
        state.index++;
        render();
      } else {
        stop();
      }
    }
    function prev(){
      if(state.index > 0){ state.index--; render(); }
    }
    function play(){
      if(state.timer) return;
      const ms = getIntervalMs();
      state.timer = setInterval(next, ms);
      document.getElementById("play").setAttribute("aria-pressed","true");
      document.getElementById("play").textContent = "⏸";
    }
    function stop(){
      if(state.timer){
        clearInterval(state.timer);
        state.timer = null;
        document.getElementById("play").setAttribute("aria-pressed","false");
        document.getElementById("play").textContent = "▶";
      }
    }
    function getIntervalMs(){
      const val = parseInt(document.getElementById("intervalMs").value, 10);
      return Number.isFinite(val) && val >= 100 ? val : 5000;
    }

    // Controls
    document.getElementById("prev").onclick = prev;
    document.getElementById("next").onclick = next;
    document.getElementById("play").onclick = () => state.timer ? stop() : play();
    document.getElementById("jumpBtn").onclick = () => {
      const v = parseInt(document.getElementById("jumpInput").value,10);
      if(Number.isFinite(v)){
        const idx = v-1;
        if(idx>=0 && idx < state.steps.length){
          state.index = idx;
          render();
        }
      }
    };

    // Spinner buttons
    document.getElementById("inc").onclick = () => {
      const el = document.getElementById("intervalMs");
      el.value = (parseInt(el.value||"0",10) + (parseInt(el.step||"500",10))).toString();
      if(state.timer){ stop(); play(); }
    };
    document.getElementById("dec").onclick = () => {
      const el = document.getElementById("intervalMs");
      const step = parseInt(el.step||"500",10);
      const nextV = Math.max(step, parseInt(el.value||"0",10) - step);
      el.value = nextV.toString();
      if(state.timer){ stop(); play(); }
    };
    document.getElementById("intervalMs").addEventListener("change", () => {
      if(state.timer){ stop(); play(); }
    });

    // Keyboard shortcuts
    window.addEventListener("keydown", (e) => {
      if(e.key === "ArrowRight") next();
      if(e.key === "ArrowLeft") prev();
      if(e.code === "Space"){ e.preventDefault(); state.timer ? stop() : play(); }
    });

    load();
  </script>
</body>
</html>
